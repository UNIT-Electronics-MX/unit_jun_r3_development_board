name: üöÄ Build Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'software/scripts/**'
      - 'software/README.md'
      - 'hardware/**'
      - 'README.md'
      - '.github/workflows/build_docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'software/scripts/**'
      - 'software/README.md'
      - 'hardware/**'
      - 'README.md'

permissions:
  contents: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup mdBook
      uses: peaceiris/actions-mdbook@v2
      with:
        mdbook-version: '0.4.52'

    - name: Generate documentation
      run: |
        echo "üöÄ Starting documentation build..."
        cd software/scripts
        python build_docs.py
        echo "‚úÖ Documentation generated successfully"

    - name: Deploy to docs directory
      run: |
        # Create docs directory if it doesn't exist
        mkdir -p docs
        
        # Copy mdBook documentation
        if [ -d "software/book/book" ]; then
          echo "üìÅ Copying mdBook documentation..."
          
          # Clear existing docs and copy new content
          rm -rf docs/mdbook
          mkdir -p docs/mdbook
          cp -r software/book/book/* docs/mdbook/
          echo "‚úÖ mdBook documentation copied to docs/mdbook/"
          
          # Create simple index.html redirect to mdbook
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=./mdbook/index.html"><title>Documentation</title></head><body><p>Redirecting... <a href="./mdbook/index.html">Click here if not redirected</a></p></body></html>' > docs/index.html
          echo "‚úÖ Index redirect created"
        else
          echo "‚ùå No mdBook build found at software/book/book"
          exit 1
        fi
        
        echo "üìÅ Final contents of docs directory:"
        ls -la docs/
        
        # GitHub Pages setup
        touch docs/.nojekyll

    - name: Deploy to repository
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        git add docs/
        if ! git diff --staged --quiet; then
          git commit -m "Deploy documentation [skip ci]"
          git push origin main
        fi
